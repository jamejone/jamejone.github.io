<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Real-time by accident | So long, and thanks for all the bits</title> <meta name="generator" content="Jekyll v4.2.0"/> <meta property="og:title" content="Real-time by accident"/> <meta name="author" content="James Jones"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="Wednesday, 8:55 AM."/> <meta property="og:description" content="Wednesday, 8:55 AM."/> <link rel="canonical" href="https://jamejone.github.io/2019/01/22/real-time-by-accident/"/> <meta property="og:url" content="https://jamejone.github.io/2019/01/22/real-time-by-accident/"/> <meta property="og:site_name" content="So long, and thanks for all the bits"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2019-01-22T00:00:00+00:00"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Real-time by accident"/> <script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://jamejone.github.io/2019/01/22/real-time-by-accident/"},"description":"Wednesday, 8:55 AM.","url":"https://jamejone.github.io/2019/01/22/real-time-by-accident/","@type":"BlogPosting","headline":"Real-time by accident","dateModified":"2021-06-13T18:07:01+00:00","datePublished":"2019-01-22T00:00:00+00:00","author":{"@type":"Person","name":"James Jones"},"@context":"https://schema.org"}</script> <meta property=”og:image” content="https://jamejone.github.io/public/office-space-meme-milton.jpg"/> <meta name="theme-color" content="#313131"/> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <link rel="manifest" href="/manifest.json"> <link rel="alternate" type="application/atom+xml" title="So long, and thanks for all the bits" href="https://jamejone.github.io/feed"> <style type="text/css">*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif;font-size:16px;line-height:1.5}@media(min-width:38em){html{font-size:20px}}body{color:#ccc;background-color:#313131;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a:hover,a:focus{text-decoration:underline}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;font-size:85%;border:1px solid #515151;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #515151}th{text-align:left}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#313131}code,pre{font-family:Menlo,Monaco,"Courier New",monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#313131;border-radius:3px}pre{margin-top:0;margin-bottom:1rem}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{padding:1rem;margin-bottom:1rem;font-size:.8rem;line-height:1.4;background-color:#313131;border-radius:.25rem}.highlight pre{margin-bottom:0;overflow-x:auto}.highlight .lineno{display:inline-block;padding-right:.75rem;padding-left:.25rem;color:#767676;-webkit-user-select:none;-moz-user-select:none;user-select:none}.container{max-width:38rem;padding-left:1.5rem;padding-right:1.5rem;margin-left:auto;margin-right:auto}footer{margin-bottom:2rem}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:2rem}.masthead-title{margin-top:0;margin-bottom:0;color:#ccc}.masthead-title a{color:inherit}.masthead-title small{font-size:75%;font-weight:400;opacity:.5}.message{margin-bottom:1rem;padding:1rem;color:#767676;background-color:#313131}.pagination{overflow:hidden;margin:0 -1.5rem 1rem;color:#515151;text-align:center}.pagination-item{display:block;padding:1rem;border:solid #515151;border-width:1px 0}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#313131}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%;border-width:1px}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}.page,.post{margin-bottom:4em}.page li+li,.post li+li{margin-top:.25rem}.page-title,.post-title,.post-title a{color:#f9f9f9}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#767676}.related{padding-top:2rem;padding-bottom:2rem;margin-bottom:2rem;border-top:1px solid #eee;border-bottom:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.highlight code,.highlight pre{color:#fdce93;background-color:#3f3f3f}.highlight .hll{background-color:#222}.highlight .err{color:#e37170;background-color:#3d3535}.highlight .k{color:#9eddfc}.highlight .p{color:#d4d4d4}.highlight .cs{color:#cd0000;font-weight:700}.highlight .gd{color:#cd0000}.highlight .ge{color:#ccc;font-style:italic}.highlight .gr{color:red}.highlight .go{color:gray}.highlight .gs{color:#ccc;font-weight:700}.highlight .gu{color:purple;font-weight:700}.highlight .gt{color:#0040d0}.highlight .kc{color:#dca3a3}.highlight .kd{color:#ffff86}.highlight .kn{color:#dfaf8f;font-weight:700}.highlight .kp{color:#cdcf99}.highlight .kr{color:#cdcd00}.highlight .ni{color:#c28182}.highlight .ne{color:#c3bf9f;font-weight:700}.highlight .nn{color:#8fbede}.highlight .vi{color:#ffffc7}.highlight .c,.highlight .g,.highlight .cm,.highlight .cp,.highlight .c1{color:#7f9f7f}.highlight .l,.highlight .x,.highlight .no,.highlight .nd,.highlight .nl,.highlight .nx,.highlight .py,.highlight .w{color:#ccc}.highlight .n,.highlight .nv,.highlight .vg{color:#d4d4d4}.highlight .o,.highlight .ow{color:#f0efd0}.highlight .gh,.highlight .gp{color:#dcdccc;font-weight:700}.highlight .gi,.highlight .kt{color:#9eddfc}.highlight .ld,.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .si,.highlight .sx,.highlight .sr,.highlight .s1,.highlight .ss{color:#cc9393}.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo,.highlight .il{color:#8cd0d3}.highlight .na,.highlight .nt{color:#9ac39f}.highlight .nb,.highlight .nc,.highlight .nf,.highlight .bp,.highlight .vc{color:#dcdbac}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:600;line-height:1.25;color:#f9f9f9;text-rendering:optimizeLegibility}
h1{font-size:2rem}h2{margin-top:1rem;font-size:1.5rem}h3{margin-top:1.5rem;font-size:1.25rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:bold}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:bold;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media(min-width:30em){blockquote{padding-right:5rem;padding-left:1.25rem}}a[href^="#fn:"],a[href^="#fnref:"]{display:inline-block;margin-left:.1rem;font-weight:bold}.footnotes{margin-top:2rem;font-size:85%}.lead{font-size:1.25rem;font-weight:300}</style> </head> <body> <div class="container content"> <header class="masthead"> <h3 class="masthead-title"> <a href="/" title="Home">So long, and thanks for all the bits</a> </h3> <h3 class="masthead-title"> <small>an engineering blog</small> </h3> <div style="margin: 3rem auto 0 auto; height: 92px;"> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7IT2JE&placement=blogcumulosoftwarecom" id="_carbonads_js"></script> <style type="text/css">#carbonads img{margin-bottom:0}#carbonads{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",Helvetica,Arial,sans-serif}#carbonads{display:block;overflow:hidden;max-width:700px;position:relative;border:solid 1px #444;box-sizing:content-box}#carbonads>span{display:block}#carbonads a{color:inherit;text-decoration:none}#carbonads a:hover{color:inherit}.carbon-wrap{display:flex;align-items:center}.carbon-img{display:block;margin:0;line-height:1}.carbon-img img{display:block;height:90px;width:auto}.carbon-text{display:block;padding:0 1em;line-height:1.35;text-align:left}.carbon-poweredby{display:block;position:absolute;bottom:0;right:0;padding:6px 10px;background:repeating-linear-gradient(-45deg,transparent,transparent 5px,hsla(0,0,0,.025) 5px,hsla(0,0,0,.025) 10px) hsla(203,11%,15%,.4);text-align:center;text-transform:uppercase;letter-spacing:.5px;font-weight:600;font-size:8px;border-top-left-radius:4px;line-height:1}@media only screen and (min-width:320px) and (max-width:759px){.carbon-text{font-size:14px}}</style> </div> </header> <main> <article class="post"> <h1 class="post-title">Real-time by accident</h1> <span class="post-date"> <time datetime="2019-01-22T00:00:00+00:00">Jan 22, 2019</time> &middot; 3 min read </span> <picture><source srcset="/generated/public/office-space-meme-milton-400-a2615a0c1.webp 400w, /generated/public/office-space-meme-milton-472-a2615a0c1.webp 472w" type="image/webp"><source srcset="/generated/public/office-space-meme-milton-400-a2615a0c1.jpg 400w, /generated/public/office-space-meme-milton-472-a2615a0c1.jpg 472w" type="image/jpeg"><img src="/generated/public/office-space-meme-milton-472-a2615a0c1.jpg"></picture> <p>Wednesday, 8:55 AM.</p> <p>You get settled into your chair and log in. Time to get some work done.</p> <p>…</p> <p>9:35 AM.</p> <p>You hear someone tapping on your doorway.</p> <p>“The 8:00 AM daily batch job failed run. Can you look into it?”</p> <p>9:51 AM.</p> <p>You discover what happened. The 4:00 AM nightly batch job took longer than usual to run. Your excellent logging indicates it was processing an usually large set of data. In fact, it’s still running right now and it’s almost complete. You fire off an email to let the concerned know what’s going on and that you’ll restart the 8:00 AM job once the 4:00 AM job is done.</p> <p>Crap! You’re late for the 10:00 AM standup.</p> <p>…</p> <p>11:05 AM.</p> <p>You finally arrive back at your desk, quickly verify the 4:00 AM job finally finished, manually kick off the job that was supposed to run at 8:00 AM, and send another email letting the user know when the job finishes. It usually only takes 30 minutes or so. Try to get some work done in the meantime.</p> <p>11:35 AM.</p> <p>Crap, the job’s still running.</p> <p>11:40 AM.</p> <p>Still running…</p> <p>11:45 AM.</p> <p>The job’s done! Fire off a third email letting them know the issue’s resolved.</p> <p>What do you know, it’s lunch time! Where’d the morning go?</p> <h3 id="heres-where-it-went">Here’s where it went</h3> <p>You spent it babysitting a faux-real-time system.</p> <p>It’s real-time in the sense that processing deadlines are imposed on the system. In our example, the 4:00 AM job has a <a href="https://en.wikipedia.org/wiki/Worst-case_execution_time">worst-case execution time</a> of 4 hours. It’s a <a href="https://en.wikipedia.org/wiki/Real-time_computing#Criteria_for_real-time_computing">hard deadline</a> in the sense that the system fails if the jobs don’t complete on-time. It’s ‘faux’ in the sense that these constraints are unnecessary and engender a lot of serious drawbacks.</p> <p>Scheduling batch jobs this way lends itself to tedious management of issues arrising from the inherent race conditions involved. Additionally, it’s difficult to determine the dependencies between the jobs since they appear more coincidental than explicit. This sort of knowledge is usually known by everyone but never defined anywhere. “Everyone knows the 4:00 AM job needs to be done before the 8:00 AM job starts!” And worst of all, these patterns tend to fail you just when you need them to work the most.</p> <p>This pattern is usually borne out of a few reasons:</p> <ul> <li>An attempt to sequence the jobs in a decoupled way,</li> <li>The availability of ‘cron’-like job scheduling tools, and</li> <li>The apparent lack of equivalently-available and simple alternatives.</li> </ul> <p>So how can we get ourselves out of this mess? Are there any alternatives?</p> <p><img src="/public/only-winning-move.gif" alt="The only winning move is not to play."/></p> <h3 id="potential-solutions">Potential solutions</h3> <h4 id="mutex-locks-dont-do-this">Mutex locks (don’t do this)</h4> <p>One solution I’ve seen at a major international company was to keep the existing scheduling system and augment it with mutex locks. Specifically:</p> <ol> <li>Create a dependency graph for every job.</li> <li>When each job starts, attempt to obtain a lock on all dependencies that job depends on (including the job itself). <ul> <li>In case of failure to obtain all the locks, release the locks and try again in several minutes.</li> <li>If all locks were successfuly obtained, start the job.</li> </ul> </li> <li>When the job finishes, release the locks that were obtained in order to start the job.</li> </ol> <p>Although this approach worked in the short-term, it was fraught with issues. If a job goes longer than usual and causes other jobs to enter a retry state, you never know which of the retrying jobs will go next. Oftentimes you want them to go in chronological order, but retry logic doesn’t naturally enable this sort of behavior. You’d need to tack on some additional logic which looks at the other jobs and this quickly gets very convoluted.</p> <p>There are other issues such as deadlocks and lost locks. Just stay away from this pattern.</p> <h4 id="event-sourcingcqrsjob-queueing">Event sourcing/CQRS/Job queueing</h4> <p>Much smarter people than me have written about these patterns in vast detail, so I won’t waste time rehashing their work. In essence, we want to remove the timing-based scheduling and replace it with chaining or queueing. The end of one job should indirectly trigger the next job, ideally without the jobs knowing about each other.</p> <p>This is roughly how it would look:</p> <ol> <li>At 4:00 AM, a command is submitted to the command queue to start Job 1.</li> <li>An agent picks up Job 1 and starts working on it. Once it ends the agent creates a “Job 1 completed” event.</li> <li>The “Job 1 completed” event is translated into a command to start Job 2 and the command is subsequently submitted to the command queue.</li> <li>An agent picks up the Job 2 command and starts working on it.</li> </ol> <p>At its heart we’re literally linking the jobs together. In other words, when one job ends another quickly starts after it. The dependency is explicitly defined in code (a “Job 1 completed” event <em>causes</em> a Job 2 command to be submitted).</p> <p>Sure, it’s possible that one job severely delays the other jobs, but in enterprise system that’s generally okay.</p> <p>As the adage goes, better late than never.</p> <h3>Thanks for reading. Feel free to leave a comment.</h3> <script src="https://utteranc.es/client.js" repo="jamejone/jamejone.github.io" issue-term="og:title" label="utterances" theme="photon-dark" crossorigin="anonymous" async> </script> </article> <aside class="related"> <h3>Related posts</h3> <ul class="related-posts"> <li> <a href="/2019/10/30/its-called-crud-for-a-reason/"> It's called 'CRUD' for a reason <small><time datetime="2019-10-30T00:00:00+00:00">30 Oct 2019</time></small> </a> </li> <li> <a href="/2019/03/02/put-your-aspnet-core-controller-on-a-diet-with-middleware/"> Put your ASP.NET Core controller on a diet with middleware <small><time datetime="2019-03-02T00:00:00+00:00">02 Mar 2019</time></small> </a> </li> <li> <a href="/2019/11/14/temporal-repository-implementation-using-mongodb-and-aspnet-core/"> Temporal repository implementation using MongoDB and ASP.NET Core <small><time datetime="2019-11-14T00:00:00+00:00">14 Nov 2019</time></small> </a> </li> </ul> </aside> </main> <footer class="footer"> <small> &copy; <time datetime="2021-06-13T18:09:43+00:00">2021</time>. All rights reserved. </small> </footer> </div> <script async src="https://www.googletagmanager.com/gtag/js?id=G-MYYT4724GY"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MYYT4724GY");</script> </body> </html>