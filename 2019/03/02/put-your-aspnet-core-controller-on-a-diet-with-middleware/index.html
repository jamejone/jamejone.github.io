<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Put your ASP.NET Core controller on a diet with middleware | So long, and thanks for all the bits</title> <meta name="generator" content="Jekyll v4.2.0"/> <meta property="og:title" content="Put your ASP.NET Core controller on a diet with middleware"/> <meta name="author" content="James Jones"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="One of the most important responsibilities of RESTful web services is that they translate business logic outcomes to the correct HTTP response code."/> <meta property="og:description" content="One of the most important responsibilities of RESTful web services is that they translate business logic outcomes to the correct HTTP response code."/> <link rel="canonical" href="https://jamejone.github.io/2019/03/02/put-your-aspnet-core-controller-on-a-diet-with-middleware/"/> <meta property="og:url" content="https://jamejone.github.io/2019/03/02/put-your-aspnet-core-controller-on-a-diet-with-middleware/"/> <meta property="og:site_name" content="So long, and thanks for all the bits"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2019-03-02T00:00:00+00:00"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Put your ASP.NET Core controller on a diet with middleware"/> <script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://jamejone.github.io/2019/03/02/put-your-aspnet-core-controller-on-a-diet-with-middleware/"},"description":"One of the most important responsibilities of RESTful web services is that they translate business logic outcomes to the correct HTTP response code.","url":"https://jamejone.github.io/2019/03/02/put-your-aspnet-core-controller-on-a-diet-with-middleware/","@type":"BlogPosting","headline":"Put your ASP.NET Core controller on a diet with middleware","dateModified":"2021-06-13T18:07:01+00:00","datePublished":"2019-03-02T00:00:00+00:00","author":{"@type":"Person","name":"James Jones"},"@context":"https://schema.org"}</script> <meta name="theme-color" content="#313131"/> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <link rel="manifest" href="/manifest.json"> <link rel="alternate" type="application/atom+xml" title="So long, and thanks for all the bits" href="https://jamejone.github.io/feed"> <style type="text/css">*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif;font-size:16px;line-height:1.5}@media(min-width:38em){html{font-size:20px}}body{color:#ccc;background-color:#313131;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a:hover,a:focus{text-decoration:underline}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;font-size:85%;border:1px solid #515151;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #515151}th{text-align:left}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#313131}code,pre{font-family:Menlo,Monaco,"Courier New",monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#313131;border-radius:3px}pre{margin-top:0;margin-bottom:1rem}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{padding:1rem;margin-bottom:1rem;font-size:.8rem;line-height:1.4;background-color:#313131;border-radius:.25rem}.highlight pre{margin-bottom:0;overflow-x:auto}.highlight .lineno{display:inline-block;padding-right:.75rem;padding-left:.25rem;color:#767676;-webkit-user-select:none;-moz-user-select:none;user-select:none}.container{max-width:38rem;padding-left:1.5rem;padding-right:1.5rem;margin-left:auto;margin-right:auto}footer{margin-bottom:2rem}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:2rem}.masthead-title{margin-top:0;margin-bottom:0;color:#ccc}.masthead-title a{color:inherit}.masthead-title small{font-size:75%;font-weight:400;opacity:.5}.message{margin-bottom:1rem;padding:1rem;color:#767676;background-color:#313131}.pagination{overflow:hidden;margin:0 -1.5rem 1rem;color:#515151;text-align:center}.pagination-item{display:block;padding:1rem;border:solid #515151;border-width:1px 0}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#313131}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%;border-width:1px}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}.page,.post{margin-bottom:4em}.page li+li,.post li+li{margin-top:.25rem}.page-title,.post-title,.post-title a{color:#f9f9f9}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#767676}.related{padding-top:2rem;padding-bottom:2rem;margin-bottom:2rem;border-top:1px solid #eee;border-bottom:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.highlight code,.highlight pre{color:#fdce93;background-color:#3f3f3f}.highlight .hll{background-color:#222}.highlight .err{color:#e37170;background-color:#3d3535}.highlight .k{color:#9eddfc}.highlight .p{color:#d4d4d4}.highlight .cs{color:#cd0000;font-weight:700}.highlight .gd{color:#cd0000}.highlight .ge{color:#ccc;font-style:italic}.highlight .gr{color:red}.highlight .go{color:gray}.highlight .gs{color:#ccc;font-weight:700}.highlight .gu{color:purple;font-weight:700}.highlight .gt{color:#0040d0}.highlight .kc{color:#dca3a3}.highlight .kd{color:#ffff86}.highlight .kn{color:#dfaf8f;font-weight:700}.highlight .kp{color:#cdcf99}.highlight .kr{color:#cdcd00}.highlight .ni{color:#c28182}.highlight .ne{color:#c3bf9f;font-weight:700}.highlight .nn{color:#8fbede}.highlight .vi{color:#ffffc7}.highlight .c,.highlight .g,.highlight .cm,.highlight .cp,.highlight .c1{color:#7f9f7f}.highlight .l,.highlight .x,.highlight .no,.highlight .nd,.highlight .nl,.highlight .nx,.highlight .py,.highlight .w{color:#ccc}.highlight .n,.highlight .nv,.highlight .vg{color:#d4d4d4}.highlight .o,.highlight .ow{color:#f0efd0}.highlight .gh,.highlight .gp{color:#dcdccc;font-weight:700}.highlight .gi,.highlight .kt{color:#9eddfc}.highlight .ld,.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .si,.highlight .sx,.highlight .sr,.highlight .s1,.highlight .ss{color:#cc9393}.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo,.highlight .il{color:#8cd0d3}.highlight .na,.highlight .nt{color:#9ac39f}.highlight .nb,.highlight .nc,.highlight .nf,.highlight .bp,.highlight .vc{color:#dcdbac}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:600;line-height:1.25;color:#f9f9f9;text-rendering:optimizeLegibility}
h1{font-size:2rem}h2{margin-top:1rem;font-size:1.5rem}h3{margin-top:1.5rem;font-size:1.25rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:bold}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:bold;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media(min-width:30em){blockquote{padding-right:5rem;padding-left:1.25rem}}a[href^="#fn:"],a[href^="#fnref:"]{display:inline-block;margin-left:.1rem;font-weight:bold}.footnotes{margin-top:2rem;font-size:85%}.lead{font-size:1.25rem;font-weight:300}</style> </head> <body> <div class="container content"> <header class="masthead"> <h3 class="masthead-title"> <a href="/" title="Home">So long, and thanks for all the bits</a> </h3> <h3 class="masthead-title"> <small>an engineering blog</small> </h3> <div style="margin: 3rem auto 0 auto; height: 92px;"> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7IT2JE&placement=blogcumulosoftwarecom" id="_carbonads_js"></script> <style type="text/css">#carbonads img{margin-bottom:0}#carbonads{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",Helvetica,Arial,sans-serif}#carbonads{display:block;overflow:hidden;max-width:700px;position:relative;border:solid 1px #444;box-sizing:content-box}#carbonads>span{display:block}#carbonads a{color:inherit;text-decoration:none}#carbonads a:hover{color:inherit}.carbon-wrap{display:flex;align-items:center}.carbon-img{display:block;margin:0;line-height:1}.carbon-img img{display:block;height:90px;width:auto}.carbon-text{display:block;padding:0 1em;line-height:1.35;text-align:left}.carbon-poweredby{display:block;position:absolute;bottom:0;right:0;padding:6px 10px;background:repeating-linear-gradient(-45deg,transparent,transparent 5px,hsla(0,0,0,.025) 5px,hsla(0,0,0,.025) 10px) hsla(203,11%,15%,.4);text-align:center;text-transform:uppercase;letter-spacing:.5px;font-weight:600;font-size:8px;border-top-left-radius:4px;line-height:1}@media only screen and (min-width:320px) and (max-width:759px){.carbon-text{font-size:14px}}</style> </div> </header> <main> <article class="post"> <h1 class="post-title">Put your ASP.NET Core controller on a diet with middleware</h1> <span class="post-date"> <time datetime="2019-03-02T00:00:00+00:00">Mar 2, 2019</time> &middot; 3 min read </span> <p>One of the most important responsibilities of RESTful web services is that they translate business logic outcomes (and unexpected errors) to the correct HTTP response code. When it comes to accomplishing this in ASP.NET Core, this logic usually ends up in the controller and looks something like this:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Put</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="n">FromForm</span><span class="p">]</span> <span class="kt">string</span> <span class="k">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="k">value</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// don't do this!</span>
        <span class="kt">var</span> <span class="n">responseObject</span> <span class="p">=</span> <span class="k">new</span> <span class="p">{</span>
            <span class="n">message</span> <span class="p">=</span> <span class="s">"value is a required parameter"</span>
        <span class="p">};</span>
        <span class="kt">string</span> <span class="n">responseBody</span> <span class="p">=</span> <span class="n">JsonConvert</span>
            <span class="p">.</span><span class="nf">SerializeObject</span><span class="p">(</span><span class="n">responseObject</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">BadRequest</span><span class="p">(</span><span class="n">responseBody</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">_repo</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>

    <span class="k">return</span> <span class="nf">Ok</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>Or even worse:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Put</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="n">FromForm</span><span class="p">]</span> <span class="kt">string</span> <span class="k">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">_repo</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">ArgumentNullException</span> <span class="n">ex</span><span class="p">)</span> <span class="c1">// ew</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">responseObject</span> <span class="p">=</span> <span class="k">new</span> <span class="p">{</span>
            <span class="n">message</span> <span class="p">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="kt">string</span> <span class="n">responseBody</span> <span class="p">=</span> <span class="n">JsonConvert</span>
            <span class="p">.</span><span class="nf">SerializeObject</span><span class="p">(</span><span class="n">responseObject</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">BadRequest</span><span class="p">(</span><span class="n">responseBody</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="c1">// gross</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">StatusCodeResult</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nf">Ok</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>The problem is that these controller methods are exceedingly thick. Every controller method requires input validation and emitting an HTTP response in the event of a validation failure. There are ways to push this validation to other places in the service layer, but the crux of the issue is that validation is in fact business logic which should really be in a domain layer.</p> <p>Ideally, we could reduce the controller methods down to something much simpler, like this:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Put</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="n">FromForm</span><span class="p">]</span> <span class="kt">string</span> <span class="k">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="k">value</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">BadRequestException</span><span class="p">(</span><span class="s">"value is required"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">_repo</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>

    <span class="k">return</span> <span class="nf">Ok</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>Or even better:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Put</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="n">FromForm</span><span class="p">]</span> <span class="kt">string</span> <span class="k">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_repo</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span> <span class="c1">//internally throw BadRequestException</span>

    <span class="k">return</span> <span class="nf">Ok</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>Where <code class="language-plaintext highlighter-rouge">BadRequestException</code> is an exception that lives in our domain layer:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">BadRequestException</span> <span class="p">:</span> <span class="n">Exception</span>
<span class="p">{</span> <span class="p">}</span>
</code></pre></div></div> <p>Getting <code class="language-plaintext highlighter-rouge">throw BadRequestException("...")</code> out of the controller and pushing it down into the domain layer is desirable, because as mentioned before, much of the business logic is captured in validation. And almost everyone can agree business logic shouldn’t be in the HTTP layer. The HTTP layer is complicated enough without having to worry about business logic!</p> <blockquote> <p>In case you’re balking at the idea of using exceptions this way, allow me the opportunity to allay your concern:</p> <p>You may want this exception to be called <code class="language-plaintext highlighter-rouge">ValidationException</code> or something less HTTP-oriented, and by all means feel free to do that. I personally think it’s fine for the domain layer to have some notion of an HTTP response since requirements are so usually so coupled with HTTP responses. To each their own. However you name it, the key is that we’re using exceptions for the validation failure workflow.</p> <p>You also might be wondering if it’s okay to use exceptions for business logic. I personally think this is fine for one big reason: Exceptions are an <em>immensely</em> powerful construct for implementing validation logic because they let you write functions as if a validation failure will never happen. They enable you write clean, happy-path function signatures that are blissfully unaware of the possibility that a validation failure may occur. And this is infinitely better than passing validation lists via reference into every function or stuffing your controller with validation logic.</p> </blockquote> <p>Anyway, back to the point of this post. Since the controller and domain layer won’t catch exceptions, then who will? You guessed it – the answer is <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/">ASP.NET Core middleware</a>. I’m telling you, it’s SO comforting knowing middleware will always be there to catch you. Seriously, once you start using this pattern you’ll never go back. So let’s get to it.</p> <p>First, we need to create a marker-like interface which will let our middleware discern between exceptions thrown by our business logic and the other, more nefarious exceptions like NullReferenceException, etc:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IHttpException</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">HttpStatusCode</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>And then we’ll fix up our <code class="language-plaintext highlighter-rouge">BadRequestException</code> to use that interface:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">BadRequestException</span> <span class="p">:</span> <span class="n">Exception</span><span class="p">,</span> <span class="n">IHttpException</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">HttpStatusCode</span> <span class="p">=&gt;</span> <span class="n">StatusCodes</span><span class="p">.</span><span class="n">Status400BadRequest</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>And, without further adieu, here’s the middleware that will handle all uncaught exceptions:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IApplicationBuilder</span> <span class="nf">UseExceptionHandlingMiddleware</span>
    <span class="p">(</span><span class="k">this</span> <span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">app</span><span class="p">.</span><span class="nf">UseExceptionHandler</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span> 
    <span class="p">{</span>
        <span class="n">options</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="kt">var</span> <span class="n">ex</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">IExceptionHandlerFeature</span><span class="p">&gt;();</span>

            <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="s">"application/json"</span><span class="p">;</span>

            <span class="kt">string</span> <span class="n">responseMessage</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">Error</span> <span class="k">is</span> <span class="n">IHttpException</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> 
                    <span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">IHttpException</span><span class="p">).</span><span class="n">HttpStatusCode</span><span class="p">;</span>
                <span class="n">responseMessage</span> <span class="p">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">Error</span><span class="p">.</span><span class="n">Message</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> 
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> 
                    <span class="n">StatusCodes</span><span class="p">.</span><span class="n">Status500InternalServerError</span><span class="p">;</span>
                <span class="n">responseMessage</span> <span class="p">=</span> <span class="s">"internal server error :("</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">responseObject</span> <span class="p">=</span> <span class="k">new</span> <span class="p">{</span>
                <span class="n">message</span> <span class="p">=</span> <span class="n">responseMessage</span>
            <span class="p">};</span>
            <span class="kt">string</span> <span class="n">responseBody</span> <span class="p">=</span> <span class="n">JsonConvert</span>
                <span class="p">.</span><span class="nf">SerializeObject</span><span class="p">(</span><span class="n">responseObject</span><span class="p">);</span>

            <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">WriteAsync</span><span class="p">(</span><span class="n">responseBody</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div> <blockquote> <p><strong><em>Note</em></strong></p> <p>Notice how exceptions which don’t match the <code class="language-plaintext highlighter-rouge">IHttpException</code> marker will emit an internal server error. Internal server errors are certainly inconvenient, but we owe it to our service consumers to be transparent when something very bad has happened! This way, we can quickly respond to critical errors in a consistent way (for example, by logging the stack trace, sending a notification to support, reaching out to the user, etc). And it’s pretty nice not having try/catches all over the place.</p> </blockquote> <p>If anything, I hope this post demonstrates the power of ASP.NET Core middleware to handle <a href="https://en.wikipedia.org/wiki/Cross-cutting_concern">cross-cutting concerns</a> such as exception handling. As a rule of thumb, pretty much any time you have code repeating in many controller methods there’s usually a way to move that code into middleware.</p> <p>Feel free to <a href="https://github.com/jamejone/http-response-exception-middleware">clone the source from GitHub</a> and see the pattern in action. The unit tests use <code class="language-plaintext highlighter-rouge">Microsoft.AspNetCore.Mvc.Testing</code> to test the entire HTTP pipeline, including the middleware. Enjoy.</p> <h3>Thanks for reading. Feel free to leave a comment.</h3> <script src="https://utteranc.es/client.js" repo="jamejone/jamejone.github.io" issue-term="og:title" label="utterances" theme="photon-dark" crossorigin="anonymous" async> </script> </article> <aside class="related"> <h3>Related posts</h3> <ul class="related-posts"> <li> <a href="/2019/01/22/real-time-by-accident/"> Real-time by accident <small><time datetime="2019-01-22T00:00:00+00:00">22 Jan 2019</time></small> </a> </li> <li> <a href="/2019/10/30/its-called-crud-for-a-reason/"> It's called 'CRUD' for a reason <small><time datetime="2019-10-30T00:00:00+00:00">30 Oct 2019</time></small> </a> </li> <li> <a href="/2019/11/14/temporal-repository-implementation-using-mongodb-and-aspnet-core/"> Temporal repository implementation using MongoDB and ASP.NET Core <small><time datetime="2019-11-14T00:00:00+00:00">14 Nov 2019</time></small> </a> </li> </ul> </aside> </main> <footer class="footer"> <small> &copy; <time datetime="2021-06-13T18:09:43+00:00">2021</time>. All rights reserved. </small> </footer> </div> <script async src="https://www.googletagmanager.com/gtag/js?id=G-MYYT4724GY"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MYYT4724GY");</script> </body> </html>