<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Temporal repository implementation using MongoDB and ASP.NET Core | So long, and thanks for all the bits</title> <meta name="generator" content="Jekyll v4.2.0"/> <meta property="og:title" content="Temporal repository implementation using MongoDB and ASP.NET Core"/> <meta name="author" content="James Jones"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="In my last post we covered why CRUD patterns can be inherently difficult to scale. If youâ€™ve reached that point, congratulations, itâ€™s time to upgrade your design."/> <meta property="og:description" content="In my last post we covered why CRUD patterns can be inherently difficult to scale. If youâ€™ve reached that point, congratulations, itâ€™s time to upgrade your design."/> <link rel="canonical" href="https://jamejone.github.io/2019/11/14/temporal-repository-implementation-using-mongodb-and-aspnet-core/"/> <meta property="og:url" content="https://jamejone.github.io/2019/11/14/temporal-repository-implementation-using-mongodb-and-aspnet-core/"/> <meta property="og:site_name" content="So long, and thanks for all the bits"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2019-11-14T00:00:00+00:00"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Temporal repository implementation using MongoDB and ASP.NET Core"/> <script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://jamejone.github.io/2019/11/14/temporal-repository-implementation-using-mongodb-and-aspnet-core/"},"description":"In my last post we covered why CRUD patterns can be inherently difficult to scale. If youâ€™ve reached that point, congratulations, itâ€™s time to upgrade your design.","url":"https://jamejone.github.io/2019/11/14/temporal-repository-implementation-using-mongodb-and-aspnet-core/","@type":"BlogPosting","headline":"Temporal repository implementation using MongoDB and ASP.NET Core","dateModified":"2021-06-13T18:07:01+00:00","datePublished":"2019-11-14T00:00:00+00:00","author":{"@type":"Person","name":"James Jones"},"@context":"https://schema.org"}</script> <meta property=â€og:imageâ€ content="https://jamejone.github.io/public/back-to-the-future.jpg"/> <meta name="theme-color" content="#313131"/> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png"> <link rel="shortcut icon" href="/public/favicon.ico"> <link rel="manifest" href="/manifest.json"> <link rel="alternate" type="application/atom+xml" title="So long, and thanks for all the bits" href="https://jamejone.github.io/feed"> <style type="text/css">*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif;font-size:16px;line-height:1.5}@media(min-width:38em){html{font-size:20px}}body{color:#ccc;background-color:#313131;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a:hover,a:focus{text-decoration:underline}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;font-size:85%;border:1px solid #515151;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #515151}th{text-align:left}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#313131}code,pre{font-family:Menlo,Monaco,"Courier New",monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#313131;border-radius:3px}pre{margin-top:0;margin-bottom:1rem}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{padding:1rem;margin-bottom:1rem;font-size:.8rem;line-height:1.4;background-color:#313131;border-radius:.25rem}.highlight pre{margin-bottom:0;overflow-x:auto}.highlight .lineno{display:inline-block;padding-right:.75rem;padding-left:.25rem;color:#767676;-webkit-user-select:none;-moz-user-select:none;user-select:none}.container{max-width:38rem;padding-left:1.5rem;padding-right:1.5rem;margin-left:auto;margin-right:auto}footer{margin-bottom:2rem}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:2rem}.masthead-title{margin-top:0;margin-bottom:0;color:#ccc}.masthead-title a{color:inherit}.masthead-title small{font-size:75%;font-weight:400;opacity:.5}.message{margin-bottom:1rem;padding:1rem;color:#767676;background-color:#313131}.pagination{overflow:hidden;margin:0 -1.5rem 1rem;color:#515151;text-align:center}.pagination-item{display:block;padding:1rem;border:solid #515151;border-width:1px 0}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#313131}@media(min-width:30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%;border-width:1px}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}.page,.post{margin-bottom:4em}.page li+li,.post li+li{margin-top:.25rem}.page-title,.post-title,.post-title a{color:#f9f9f9}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#767676}.related{padding-top:2rem;padding-bottom:2rem;margin-bottom:2rem;border-top:1px solid #eee;border-bottom:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.highlight code,.highlight pre{color:#fdce93;background-color:#3f3f3f}.highlight .hll{background-color:#222}.highlight .err{color:#e37170;background-color:#3d3535}.highlight .k{color:#9eddfc}.highlight .p{color:#d4d4d4}.highlight .cs{color:#cd0000;font-weight:700}.highlight .gd{color:#cd0000}.highlight .ge{color:#ccc;font-style:italic}.highlight .gr{color:red}.highlight .go{color:gray}.highlight .gs{color:#ccc;font-weight:700}.highlight .gu{color:purple;font-weight:700}.highlight .gt{color:#0040d0}.highlight .kc{color:#dca3a3}.highlight .kd{color:#ffff86}.highlight .kn{color:#dfaf8f;font-weight:700}.highlight .kp{color:#cdcf99}.highlight .kr{color:#cdcd00}.highlight .ni{color:#c28182}.highlight .ne{color:#c3bf9f;font-weight:700}.highlight .nn{color:#8fbede}.highlight .vi{color:#ffffc7}.highlight .c,.highlight .g,.highlight .cm,.highlight .cp,.highlight .c1{color:#7f9f7f}.highlight .l,.highlight .x,.highlight .no,.highlight .nd,.highlight .nl,.highlight .nx,.highlight .py,.highlight .w{color:#ccc}.highlight .n,.highlight .nv,.highlight .vg{color:#d4d4d4}.highlight .o,.highlight .ow{color:#f0efd0}.highlight .gh,.highlight .gp{color:#dcdccc;font-weight:700}.highlight .gi,.highlight .kt{color:#9eddfc}.highlight .ld,.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .si,.highlight .sx,.highlight .sr,.highlight .s1,.highlight .ss{color:#cc9393}.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo,.highlight .il{color:#8cd0d3}.highlight .na,.highlight .nt{color:#9ac39f}.highlight .nb,.highlight .nc,.highlight .nf,.highlight .bp,.highlight .vc{color:#dcdbac}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:600;line-height:1.25;color:#f9f9f9;text-rendering:optimizeLegibility}
h1{font-size:2rem}h2{margin-top:1rem;font-size:1.5rem}h3{margin-top:1.5rem;font-size:1.25rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:bold}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:bold;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media(min-width:30em){blockquote{padding-right:5rem;padding-left:1.25rem}}a[href^="#fn:"],a[href^="#fnref:"]{display:inline-block;margin-left:.1rem;font-weight:bold}.footnotes{margin-top:2rem;font-size:85%}.lead{font-size:1.25rem;font-weight:300}</style> </head> <body> <div class="container content"> <header class="masthead"> <h3 class="masthead-title"> <a href="/" title="Home">So long, and thanks for all the bits</a> </h3> <h3 class="masthead-title"> <small>an engineering blog</small> </h3> <div style="margin: 3rem auto 0 auto; height: 92px;"> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7IT2JE&placement=blogcumulosoftwarecom" id="_carbonads_js"></script> <style type="text/css">#carbonads img{margin-bottom:0}#carbonads{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",Helvetica,Arial,sans-serif}#carbonads{display:block;overflow:hidden;max-width:700px;position:relative;border:solid 1px #444;box-sizing:content-box}#carbonads>span{display:block}#carbonads a{color:inherit;text-decoration:none}#carbonads a:hover{color:inherit}.carbon-wrap{display:flex;align-items:center}.carbon-img{display:block;margin:0;line-height:1}.carbon-img img{display:block;height:90px;width:auto}.carbon-text{display:block;padding:0 1em;line-height:1.35;text-align:left}.carbon-poweredby{display:block;position:absolute;bottom:0;right:0;padding:6px 10px;background:repeating-linear-gradient(-45deg,transparent,transparent 5px,hsla(0,0,0,.025) 5px,hsla(0,0,0,.025) 10px) hsla(203,11%,15%,.4);text-align:center;text-transform:uppercase;letter-spacing:.5px;font-weight:600;font-size:8px;border-top-left-radius:4px;line-height:1}@media only screen and (min-width:320px) and (max-width:759px){.carbon-text{font-size:14px}}</style> </div> </header> <main> <article class="post"> <h1 class="post-title">Temporal repository implementation using MongoDB and ASP.NET Core</h1> <span class="post-date"> <time datetime="2019-11-14T00:00:00+00:00">Nov 14, 2019</time> &middot; 2 min read </span> <picture><source srcset="/generated/public/back-to-the-future-400-5e1c2df79.webp 400w, /generated/public/back-to-the-future-600-5e1c2df79.webp 600w, /generated/public/back-to-the-future-800-5e1c2df79.webp 800w, /generated/public/back-to-the-future-950-5e1c2df79.webp 950w" type="image/webp"><source srcset="/generated/public/back-to-the-future-400-5e1c2df79.jpg 400w, /generated/public/back-to-the-future-600-5e1c2df79.jpg 600w, /generated/public/back-to-the-future-800-5e1c2df79.jpg 800w, /generated/public/back-to-the-future-950-5e1c2df79.jpg 950w" type="image/jpeg"><img src="/generated/public/back-to-the-future-800-5e1c2df79.jpg"></picture> <p><a href="/2019/10/30/its-called-crud-for-a-reason/">In my last post</a> we covered why CRUD patterns can be inherently difficult to scale. If youâ€™ve reached that point, congratulations, itâ€™s time to upgrade your design. In this post weâ€™ll cover a different kind of data access pattern thatâ€™s a little more complicated than CRUD, but offers some benefits that just might make it worthwhile.</p> <p>The key to scalable systems is asyncronous processing. And the key to asyncronous processing is adopting data structures that facilitate asyncronous processing. One such data structure is the â€˜temporalâ€™ repository.</p> <blockquote> <p>temporal (Ëˆtemp(É™)rÉ™l)</p> <p><em>adjective</em></p> <ol> <li>relating to time.</li> </ol> </blockquote> <p>The temporal repository is capable of knowing not just the current state of the entities within it <em>but also their prior states</em>. This repo has the memory of an elephant and knows not just facts about the world, but also <strong>when</strong> it came to know about them. Hereâ€™s what such an interface looks like:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">ITemporalRepository</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Saves the entity to the database.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">Task</span> <span class="nf">SaveAsync</span><span class="p">(</span><span class="n">T</span> <span class="n">entity</span><span class="p">);</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets the latest version of the entity from the database.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="nf">GetAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">identifier</span><span class="p">);</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets a version of the entity as of a given point in time.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="nf">GetAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">DateTime</span> <span class="n">asOf</span><span class="p">);</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets the complete history of an entity.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">IAsyncEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="nf">GetHistoryAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">identifier</span><span class="p">);</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets the latest versions of all the entities in the</span>
    <span class="c1">/// database.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">IAsyncEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="nf">GetAllAsync</span><span class="p">();</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets all the entities from the database as of a given</span>
    <span class="c1">/// point in time.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">IAsyncEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="nf">GetAllAsync</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">asOf</span><span class="p">);</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Purges historical versions of an entity beyond a given</span>
    <span class="c1">/// point in time. Keeps however many versions specified.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">Task</span> <span class="nf">PurgeHistoricalVersionsAsync</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">howFarBackToPurge</span><span class="p">,</span> <span class="kt">int</span> <span class="n">minVersionsToKeep</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>As you can see, by enabling our data model to travel backwards in time, we end up with more than just the standard four CRUD routines. This interface enables us to do some pretty cool stuff, namely:</p> <ul> <li>Coordinate multiple batch processes to asynchronously process the system as of an exact point in time. In other words, we have an immutable data set. We donâ€™t have to worry about anyone pulling the rug out from under us and retries can be idempotent.</li> <li>Perform diffs on the data, for example to understand what has changed since the last time a batch process was ran.</li> <li>Provide an audit log, which is immensely useful for debugging and is oftentimes required to meet regulatory requirements.</li> <li>Retroactively process data as of a specific point in time in the past (i.e. quarterly reporting).</li> </ul> <p>You get all of this and more without ever needing to create a transaction.</p> <h3 id="see-it-in-action">See it in action</h3> <p>Iâ€™ve created a demo of this pattern using ASP.NET Core 3.0, MongoDB and Docker. One thing I love about Docker is that you donâ€™t need to install MongoDB just to see this demo work. Simply run the Docker Compose file and youâ€™re off to the races. I should also mention this can run on both macOS and Windows. I know because I developed this demo on both a MacBook and a Windows PC. ðŸ¤ </p> <p>To run the demo Iâ€™d recommend installing the following software:</p> <ul> <li><a href="https://visualstudio.microsoft.com/downloads/">Visual Studio 2019</a></li> <li>Docker (along with Kitematic for managing containers)</li> </ul> <p>Next, <a href="https://github.com/jamejone/temporal-repository-pattern">clone or download the source from my GitHub</a>. You should be able to simply open the solution in Visual Studio and run the docker-compose project. In Kitematic, use Ctrl + R (or âŒ˜ + R) to refresh the container list. You should see the list of Docker containers that were created and you should observe that the MongoDB cluster has formed:</p> <picture><source srcset="/generated/public/temporal-repository-pattern-kitematic-400-78d9fb0f2.webp 400w, /generated/public/temporal-repository-pattern-kitematic-600-78d9fb0f2.webp 600w, /generated/public/temporal-repository-pattern-kitematic-800-78d9fb0f2.webp 800w, /generated/public/temporal-repository-pattern-kitematic-1000-78d9fb0f2.webp 1000w" type="image/webp"/><source srcset="/generated/public/temporal-repository-pattern-kitematic-400-78d9fb0f2.png 400w, /generated/public/temporal-repository-pattern-kitematic-600-78d9fb0f2.png 600w, /generated/public/temporal-repository-pattern-kitematic-800-78d9fb0f2.png 800w, /generated/public/temporal-repository-pattern-kitematic-1000-78d9fb0f2.png 1000w" type="image/png"/><img src="/generated/public/temporal-repository-pattern-kitematic-800-78d9fb0f2.png" alt="'Kitematic shows that all the containers are running and the MongoDB cluster is formed.'"/></picture> <p>Next, use the Test Explorer in Visual Studio to run the integration tests and observe that they all pass:</p> <picture><source srcset="/generated/public/temporal-repository-pattern-integration-tests-400-68d715f0f.webp 400w, /generated/public/temporal-repository-pattern-integration-tests-600-68d715f0f.webp 600w, /generated/public/temporal-repository-pattern-integration-tests-710-68d715f0f.webp 710w" type="image/webp"/><source srcset="/generated/public/temporal-repository-pattern-integration-tests-400-68d715f0f.png 400w, /generated/public/temporal-repository-pattern-integration-tests-600-68d715f0f.png 600w, /generated/public/temporal-repository-pattern-integration-tests-710-68d715f0f.png 710w" type="image/png"/><img src="/generated/public/temporal-repository-pattern-integration-tests-710-68d715f0f.png" alt="'Visual Studio shows that all the integration tests are passing.'"/></picture> <p>I think Iâ€™ve said enough for one blog post. Go ahead, set some breakpoints and tinker around. If youâ€™d like to connect to the local MongoDB cluster you can connect to it on the default port 27017. If you have MongoDB Compass you should be able to simply open it up and hit â€˜Connectâ€™.</p> <p><img src="/public/make-like-a-tree-and-get-outta-here.gif" alt="The way I see it, if you're going to build a time machine into a car, why not do it with some style?"/></p> <h3>Thanks for reading. Feel free to leave a comment.</h3> <script src="https://utteranc.es/client.js" repo="jamejone/jamejone.github.io" issue-term="og:title" label="utterances" theme="photon-dark" crossorigin="anonymous" async> </script> </article> <aside class="related"> <h3>Related posts</h3> <ul class="related-posts"> <li> <a href="/2019/10/30/its-called-crud-for-a-reason/"> It's called 'CRUD' for a reason <small><time datetime="2019-10-30T00:00:00+00:00">30 Oct 2019</time></small> </a> </li> <li> <a href="/2019/01/22/real-time-by-accident/"> Real-time by accident <small><time datetime="2019-01-22T00:00:00+00:00">22 Jan 2019</time></small> </a> </li> <li> <a href="/2019/03/02/put-your-aspnet-core-controller-on-a-diet-with-middleware/"> Put your ASP.NET Core controller on a diet with middleware <small><time datetime="2019-03-02T00:00:00+00:00">02 Mar 2019</time></small> </a> </li> </ul> </aside> </main> <footer class="footer"> <small> &copy; <time datetime="2021-06-13T18:09:43+00:00">2021</time>. All rights reserved. </small> </footer> </div> <script async src="https://www.googletagmanager.com/gtag/js?id=G-MYYT4724GY"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MYYT4724GY");</script> </body> </html>